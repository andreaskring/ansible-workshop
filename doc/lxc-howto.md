# Introduction to LXC

## Setting up a Linux container

Lets install LXC and install a container running Ubuntu.

### Install LXC and create a container

```
$ sudo apt install lxc
$ sudo lxc-create -t download -n ubuntu
```

where “ubuntu” is just the name of the container. When prompted for distribution,
release and architecture choose e.g. ubuntu, xenial and amd64, respectively.
LXC will now setup an Ubuntu container. To start the container do the
following:

```
$ sudo lxc-start -n ubuntu
```

Attach to the container by doing:

```
$ sudo lxc-attach -n ubuntu
```

### Add a user

You will now get root access to the container. Add a normal user (choose 
the same username as the user on your machine running the LXC container), 
add this user to the sudoers group and install and start an
SSH-server:

```
$ adduser <username>
$ usermod -aG sudo <username>
```

### Install an SSH server

Install the OpenSSH server:

```
$ apt install openssh-server
```

### Assign a static IP address to the container

Lookup the IP-address of the container:

```
$ ifconfig
eth0          Link encap:Ethernet  HWaddr 00:16:3e:d5:57:a9
              inet addr:10.0.3.248  Bcast:10.0.3.255  Mask:255.255.255.0
              inet6 addr: fe80::216:3eff:fed5:57a9/64 Scope:Link
              UP BROADCAST RUNNING MULTICAST  MTU:1500  Metric:1
              RX packets:2170 errors:0 dropped:0 overruns:0 frame:0
              TX packets:1526 errors:0 dropped:0 overruns:0 carrier:0
              collisions:0 txqueuelen:1000
              RX bytes:21592926 (21.5 MB)  TX bytes:132278 (132.2 KB)

lo            Link encap:Local Loopback
              inet addr:127.0.0.1  Mask:255.0.0.0
              inet6 addr: ::1/128 Scope:Host
              UP LOOPBACK RUNNING  MTU:65536  Metric:1
              RX packets:2121 errors:0 dropped:0 overruns:0 frame:0
              TX packets:2121 errors:0 dropped:0 overruns:0 carrier:0
              collisions:0 txqueuelen:1
```

We see that the IP-address in this case is 10.0.3.248. However, we would like 
to assign a static IP-address to the server so the this will not change 
when we reboot or roll back the container to a previous snapshot (see later).  

Lets assign the IP-address 10.0.3.5 to the container. Edit the file 
`/etc/network/interfaces` to look like this:

```
# This file describes the network interfaces available on your system
# and how to activate them. For more information, see interfaces(5).

# The loopback network interface
auto lo
iface lo inet loopback

auto eth0
iface eth0 inet static
	address 10.0.3.5
	netmask 255.255.255.0
	gateway 10.0.3.1
	dns-nameservers 10.0.3.1

```

Take the `eth0` interface down and bring it up again:

```
$ sudo ifdown eth0
$ sudo ifup eth0
```

Veryfi that the IP-address of the container is now 10.0.3.5

<pre>
$ ifconfig
eth0          Link encap:Ethernet  HWaddr 00:16:3e:d5:57:a9
              inet addr:10.0.3.5  Bcast:10.0.3.255  Mask:255.255.255.0
              inet6 addr: fe80::216:3eff:fed5:57a9/64 Scope:Link
              UP BROADCAST RUNNING MULTICAST  MTU:1500  Metric:1
              RX packets:2170 errors:0 dropped:0 overruns:0 frame:0
              TX packets:1526 errors:0 dropped:0 overruns:0 carrier:0
              collisions:0 txqueuelen:1000
              RX bytes:21592926 (21.5 MB)  TX bytes:132278 (132.2 KB)

lo            Link encap:Local Loopback
              inet addr:127.0.0.1  Mask:255.0.0.0
              inet6 addr: ::1/128 Scope:Host
              UP LOOPBACK RUNNING  MTU:65536  Metric:1
              RX packets:2121 errors:0 dropped:0 overruns:0 frame:0
              TX packets:2121 errors:0 dropped:0 overruns:0 carrier:0
              collisions:0 txqueuelen:1
</pre>

and that the nameserver is set to 10.0.3.1 (the host machine):

<pre>
$ cat /etc/resolv.conf
# Dynamic resolv.conf(5) file for glibc resolver(3) generated by resolvconf(8)
#     DO NOT EDIT THIS FILE BY HAND -- YOUR CHANGES WILL BE OVERWRITTEN
nameserver 10.0.3.1
</pre>


### Hostname and SSH public keys

Now you can log out of the container (`Ctrl-D`). On the host machine, add the 
line

<pre>
10.0.3.5	ubuntu
</pre>

to `/etc/hosts`. It is now possible to SSH into the container:

<pre>
$ ssh ubuntu
</pre>

But let's upload our SSH public key to the container for convenience:

<pre>
$ ssh-copy-id <username>@ubuntu
</pre>

Thats it - we are good to go!

## Working with snapshots

A very cool feature is that you can take a snapshot (or several) of a container 
and roll back to such a snapshot if you mess something up later on. 
Let's take a snapshot of our container right away so that we can 
always roll back to this moment in time (where we have prepared all 
of the above with the user, IP-addresses, SSH keys an so on).  

First, we have to stop the container:

<pre>
$ sudo lxc-stop -n ubuntu
</pre>

And then take the snapshot

<pre>
$ sudo lxc-snapshot -n ubuntu
</pre>

Verify that you have a snapshot:

<pre>
$ sudo lxc-snapshot -n ubuntu -L
snap0 (/var/lib/lxc/ubuntu/snaps) 2018:02:21 10:14:51
</pre>

Start the container again

<pre>
$ sudo lxc-start -n ubuntu
</pre>

and when you at some point later on wish to roll back to `snap0` 
do this:

<pre>
$ sudo lxc-stop -n ubuntu
$ sudo lxc-snapshot -n ubuntu -r snap0
$ sudo lxc-start -n ubuntu
</pre>
